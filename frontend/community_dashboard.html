<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   DisasterEye - Community Dashboard
  </title>
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <!-- Leaflet CSS -->
  <link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" rel="stylesheet">
   <!-- SweetAlert2 CSS -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.min.css" rel="stylesheet"/>
   <!-- Global Theme CSS -->
   <link href="style.css" rel="stylesheet"/>
   <!-- Page Specific CSS -->
   <link href="community_dashboard.css" rel="stylesheet"/>
  </link>
 </head>
 <body>
  <!-- Community Leader Header -->
  <header class="navbar navbar-expand bg-white border-bottom shadow-sm">
   <div class="container-fluid">
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle sidebar" class="btn d-md-none" data-bs-target="#sidebarMenu" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center gap-2" href="./community_dashboard.html">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/56/56'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:28px;"/>
     <span class="fw-bold" style="color:#FF0000">
      DisasterEye
     </span>
    </a>
    <form class="ms-auto me-3 d-none d-md-block" role="search" style="max-width:360px;">
     <div class="input-group">
      <span class="input-group-text bg-white">
       <i class="fa-solid fa-magnifying-glass text-muted">
       </i>
      </span>
      <input aria-label="Search" class="form-control" id="globalSearchInput" placeholder="Search incidents by type, severity..." type="search"/>
     </div>
    </form>
    <div class="d-flex align-items-center gap-2">
     <a class="btn btn-outline-danger btn-sm" href="./community_dashboard.html#refresh" id="btnRefresh">
      <i class="fa-solid fa-rotate me-1">
      </i>
      Refresh
     </a>
     <div class="dropdown">
      <a aria-expanded="false" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">
       <i class="fa-solid fa-user-circle me-1">
       </i>
       <span id="headerUserName">
        Alex Johnson
       </span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
       <li>
        <a class="dropdown-item" href="./profile_settings.html">
         <i class="fa-solid fa-gear me-2">
         </i>
         Settings
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <a class="dropdown-item text-danger" href="./login_page.html" id="btnLogout">
         <i class="fa-solid fa-right-from-bracket me-2">
         </i>
         Logout
        </a>
       </li>
      </ul>
     </div>
    </div>
   </div>
  </header>
  <div class="dashboard-wrapper d-flex">
   <!-- Component: Community Leader Sidebar -->
   <nav class="collapse d-md-block bg-white border-end" id="sidebarMenu" style="min-height:100vh; width:280px;">
    <div class="position-sticky">
     <div class="p-3 border-bottom d-flex align-items-center gap-2">
      <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/64/64'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:32px;"/>
      <span class="fw-bold">
       DisasterEye
      </span>
     </div>
     <div class="p-3">
      <div class="d-flex align-items-center gap-2 mb-3">
       <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
        <i class="fa-solid fa-user text-secondary">
        </i>
       </div>
       <div>
        <div class="fw-semibold" id="sidebarUserName">
         Alex Johnson
        </div>
        <div class="badge" style="background-color:#FFD700; color:#000;">
         Community Leader
        </div>
       </div>
      </div>
      <ul class="nav nav-pills flex-column gap-1">
       <li class="nav-item">
        <a class="nav-link d-flex align-items-center active" href="./community_dashboard.html">
         <i class="fa-solid fa-chart-line me-2 text-danger">
         </i>
         Dashboard
        </a>
       </li>
       <li class="nav-item">
        <button aria-expanded="true" class="btn w-100 text-start nav-link d-flex align-items-center" data-bs-target="#mapIncidents" data-bs-toggle="collapse">
         <i class="fa-solid fa-map-location-dot me-2 text-danger">
         </i>
         Map &amp; Incidents
         <i class="fa-solid fa-chevron-down ms-auto small">
         </i>
        </button>
        <div class="collapse show ps-3" id="mapIncidents">
         <ul class="nav flex-column gap-1">
          <li class="nav-item">
           <a class="nav-link" href="./community_dashboard.html#filters">
            <i class="fa-solid fa-filter me-2 text-muted">
            </i>
            Filters
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link" href="./incident_details.html">
            <i class="fa-solid fa-clipboard-list me-2 text-muted">
            </i>
            Incident Details
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link" href="./safety_guides.html">
            <i class="fa-solid fa-flag me-2 text-muted">
            </i>
            Safety Guides
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="nav-item">
        <a class="nav-link d-flex align-items-center" href="./community_dashboard.html#assignments">
         <i class="fa-solid fa-people-group me-2 text-danger">
         </i>
         Team Assignments
        </a>
       </li>
      </ul>
     </div>
    </div>
   </nav>
   <!-- Main Content -->
   <main class="flex-grow-1">
    <div class="container-fluid py-3 py-md-4">
     <!-- Page Header -->
     <div class="page-header mb-3">
      <div class="d-flex align-items-center gap-2">
       <h1 class="page-title mb-0">
        Community Dashboard
       </h1>
       <span class="badge bg-warning text-dark">
        Live
       </span>
      </div>
      <div class="d-flex align-items-center gap-2">
       <div class="view-switcher d-none d-md-inline-flex">
        <div class="option active" title="Map &amp; Feed">
         <i class="fa-solid fa-table-columns">
         </i>
        </div>
        <div class="option" title="Table">
         <i class="fa-solid fa-table">
         </i>
        </div>
       </div>
       <button class="btn btn-light" id="btnExport">
        <i class="fa-solid fa-file-export me-1">
        </i>
        Export
       </button>
      </div>
     </div>
     <div class="row g-3 g-lg-4">
      <!-- Left Column: Map + Metrics/Chart -->
      <div class="col-lg-8 col-xl-9">
       <!-- Key Metrics -->
       <div class="row g-3 mb-3">
        <div class="col-12 col-sm-6 col-xl-4">
         <div class="metric-card">
          <div class="metric-title">
           Total Incidents (24h)
          </div>
          <div class="d-flex align-items-end justify-content-between">
           <div class="metric-value" id="metricTotal">
            —
           </div>
           <i class="fa-solid fa-bolt text-warning fs-4">
           </i>
          </div>
          <small class="text-muted">
           Validated reports only
          </small>
         </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-4">
         <div class="metric-card">
          <div class="metric-title">
           Active
          </div>
          <div class="d-flex align-items-end justify-content-between">
           <div class="metric-value text-danger" id="metricActive">
            —
           </div>
           <i class="fa-solid fa-triangle-exclamation text-danger fs-4">
           </i>
          </div>
          <small class="text-muted">
           New + In Progress
          </small>
         </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-4">
         <div class="metric-card">
          <div class="metric-title">
           Volunteers Deployed
          </div>
          <div class="d-flex align-items-end justify-content-between">
           <div class="metric-value text-success" id="metricVolunteers">
            —
           </div>
           <i class="fa-solid fa-people-group text-success fs-4">
           </i>
          </div>
          <small class="text-muted">
           Field &amp; support roles
          </small>
         </div>
        </div>
       </div>
       <!-- Interactive Incident Map -->
       <div class="card app-card mb-3">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-map-location-dot text-danger">
          </i>
          <span class="widget-title">
           Interactive Incident Map
          </span>
         </div>
         <div class="d-flex align-items-center gap-2">
          <button class="btn btn-light btn-sm" id="btnResetMap">
           <i class="fa-solid fa-crosshairs me-1">
           </i>
           Reset View
          </button>
         </div>
        </div>
        <div class="card-body p-0">
         <div aria-label="Incident Map" id="incidentMap" role="region">
         </div>
         <div class="p-2 border-top bg-light small d-flex flex-wrap align-items-center gap-2">
          <div class="fw-semibold">
           Legend:
          </div>
          <span class="badge-soft error">
           Fire
          </span>
          <span class="badge-soft info">
           Flood
          </span>
          <span class="badge-soft warning">
           Earthquake
          </span>
          <span class="badge-soft secondary">
           Storm
          </span>
          <span class="badge-soft success">
           Landslide
          </span>
          <span class="ms-auto text-muted">
           <i class="fa-regular fa-circle me-1">
           </i>
           Size = Severity
          </span>
         </div>
        </div>
       </div>
       <!-- Incidents by Type (Chart) -->
       <div class="card app-card">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-chart-column text-danger">
          </i>
          <span class="widget-title">
           Incidents by Type (24h)
          </span>
         </div>
        </div>
        <div class="card-body">
         <canvas aria-label="Incidents by Type chart" height="120" id="typeBarChart" role="img">
         </canvas>
        </div>
       </div>
      </div>
      <!-- Right Column: Filters + Feed/Table -->
      <div class="col-lg-4 col-xl-3">
       <!-- Filter Controls -->
       <div class="card app-card sticky-filters" id="filters">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-filter text-danger">
          </i>
          <span class="widget-title">
           Filter Controls
          </span>
         </div>
         <button class="btn btn-light btn-sm" id="btnResetFilters">
          <i class="fa-solid fa-rotate">
          </i>
         </button>
        </div>
        <div class="card-body">
         <form class="small" id="filtersForm">
          <div class="mb-3">
           <label class="form-label">
            Disaster Types
           </label>
           <div class="row g-2">
            <div class="col-6">
             <div class="form-check">
              <input checked="" class="form-check-input disaster-type" id="typeFire" type="checkbox" value="Fire"/>
              <label class="form-check-label" for="typeFire">
               <i class="fa-solid fa-fire text-danger me-1">
               </i>
               Fire
              </label>
             </div>
            </div>
            <div class="col-6">
             <div class="form-check">
              <input checked="" class="form-check-input disaster-type" id="typeFlood" type="checkbox" value="Flood"/>
              <label class="form-check-label" for="typeFlood">
               <i class="fa-solid fa-water text-info me-1">
               </i>
               Flood
              </label>
             </div>
            </div>
            <div class="col-6">
             <div class="form-check">
              <input checked="" class="form-check-input disaster-type" id="typeEarthquake" type="checkbox" value="Earthquake"/>
              <label class="form-check-label" for="typeEarthquake">
               <i class="fa-solid fa-house-crack text-warning me-1">
               </i>
               Earthquake
              </label>
             </div>
            </div>
            <div class="col-6">
             <div class="form-check">
              <input checked="" class="form-check-input disaster-type" id="typeStorm" type="checkbox" value="Storm"/>
              <label class="form-check-label" for="typeStorm">
               <i class="fa-solid fa-cloud-bolt text-secondary me-1">
               </i>
               Storm
              </label>
             </div>
            </div>
            <div class="col-6">
             <div class="form-check">
              <input checked="" class="form-check-input disaster-type" id="typeLandslide" type="checkbox" value="Landslide"/>
              <label class="form-check-label" for="typeLandslide">
               <i class="fa-solid fa-mountain text-success me-1">
               </i>
               Landslide
              </label>
             </div>
            </div>
           </div>
          </div>
          <div class="mb-3">
           <label class="form-label">
            Status
           </label>
           <select class="form-select" id="statusFilter">
            <option selected="" value="All">
             All
            </option>
            <option value="New">
             New
            </option>
            <option value="In Progress">
             In Progress
            </option>
            <option value="Resolved">
             Resolved
            </option>
           </select>
          </div>
          <div class="mb-3">
           <label class="form-label">
            Severity
           </label>
           <select class="form-select" id="severityFilter">
            <option selected="" value="0">
             All
            </option>
            <option value="1">
             1+
            </option>
            <option value="2">
             2+
            </option>
            <option value="3">
             3+
            </option>
            <option value="4">
             4+
            </option>
            <option value="5">
             5 only
            </option>
           </select>
          </div>
          <div class="mb-2">
           <label class="form-label">
            Date Range
           </label>
           <div class="row g-2">
            <div class="col-6">
             <input class="form-control" id="dateFrom" type="date">
             </input>
            </div>
            <div class="col-6">
             <input class="form-control" id="dateTo" type="date">
             </input>
            </div>
           </div>
          </div>
          <div class="d-grid gap-2 mt-3">
           <button class="btn btn-primary" id="btnApplyFilters" type="button">
            <i class="fa-solid fa-filter me-1">
            </i>
            Apply
           </button>
           <button class="btn btn-light" id="btnClearFilters" type="button">
            Clear
           </button>
          </div>
         </form>
        </div>
       </div>
       <!-- Feed/Table Tabs -->
       <ul class="nav nav-tabs mt-3" id="feedTabs" role="tablist">
        <li class="nav-item" role="presentation">
         <button aria-controls="feedPane" aria-selected="true" class="nav-link active" data-bs-target="#feedPane" data-bs-toggle="tab" id="feed-tab" role="tab" type="button">
          <i class="fa-solid fa-list me-1">
          </i>
          Feed
         </button>
        </li>
        <li class="nav-item" role="presentation">
         <button aria-controls="tablePane" aria-selected="false" class="nav-link" data-bs-target="#tablePane" data-bs-toggle="tab" id="table-tab" role="tab" type="button">
          <i class="fa-solid fa-table me-1">
          </i>
          Table
         </button>
        </li>
       </ul>
       <div class="tab-content border border-top-0 rounded-bottom bg-white shadow-sm">
        <!-- Incident Feed -->
        <div aria-labelledby="feed-tab" class="tab-pane fade show active p-3" id="feedPane" role="tabpanel">
         <div class="d-grid gap-2" id="incidentFeed">
          <!-- Feed items injected here -->
          <div class="skeleton">
          </div>
          <div class="skeleton">
          </div>
          <div class="skeleton">
          </div>
         </div>
         <div class="d-flex align-items-center justify-content-between mt-3">
          <small class="text-muted" id="feedPageInfo">
           Page 1 of 1
          </small>
          <div>
           <button class="btn btn-light btn-sm me-1" disabled="" id="feedPrev">
            <i class="fa-solid fa-chevron-left">
            </i>
           </button>
           <button class="btn btn-light btn-sm" disabled="" id="feedNext">
            <i class="fa-solid fa-chevron-right">
            </i>
           </button>
          </div>
         </div>
        </div>
        <!-- Incident Table -->
        <div aria-labelledby="table-tab" class="tab-pane fade p-3" id="tablePane" role="tabpanel">
         <div class="table-responsive">
          <table class="table table-theme align-middle" id="incidentsTable">
           <thead>
            <tr>
             <th>
              Title
             </th>
             <th class="sortable" data-sort="type" role="button">
              Type
              <i class="fa-solid fa-sort ms-1">
              </i>
             </th>
             <th class="sortable" data-sort="severity" role="button">
              Severity
              <i class="fa-solid fa-sort ms-1">
              </i>
             </th>
             <th class="sortable" data-sort="status" role="button">
              Status
              <i class="fa-solid fa-sort ms-1">
              </i>
             </th>
             <th class="sortable" data-sort="timestamp" role="button">
              Time
              <i class="fa-solid fa-sort ms-1">
              </i>
             </th>
             <th>
              Actions
             </th>
            </tr>
           </thead>
           <tbody id="incidentsTableBody">
            <tr>
             <td colspan="6">
              <div class="skeleton" style="height:18px">
              </div>
             </td>
            </tr>
            <tr>
             <td colspan="6">
              <div class="skeleton" style="height:18px">
              </div>
             </td>
            </tr>
           </tbody>
          </table>
         </div>
         <div class="d-flex align-items-center justify-content-between mt-2">
          <small class="text-muted" id="tablePageInfo">
           Page 1 of 1
          </small>
          <div>
           <button class="btn btn-light btn-sm me-1" disabled="" id="tablePrev">
            <i class="fa-solid fa-chevron-left">
            </i>
           </button>
           <button class="btn btn-light btn-sm" disabled="" id="tableNext">
            <i class="fa-solid fa-chevron-right">
            </i>
           </button>
          </div>
         </div>
        </div>
       </div>
       <!-- Team Assignments Anchor Placeholder -->
       <div class="mt-4" id="assignments">
        <div class="alert alert-info mb-0">
         <i class="fa-solid fa-people-line me-2">
         </i>
         Team assignments module will appear here.
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Community Leader Footer -->
  <footer class="border-top bg-light mt-auto">
   <div class="container py-3 d-flex flex-wrap align-items-center justify-content-between small">
    <div class="d-flex align-items-center gap-2">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/36/36'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:18px;"/>
     <span class="text-muted">
      DisasterEye
     </span>
    </div>
    <ul class="nav">
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="./terms.html">
       Terms
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="./privacy.html">
       Privacy
      </a>
     </li>
     <li class="nav-item d-none d-md-block">
      <a class="btn btn-outline-danger btn-sm ms-2" href="./community_dashboard.html#export">
       <i class="fa-solid fa-file-export me-1">
       </i>
       Export
      </a>
     </li>
    </ul>
   </div>
  </footer>
  <!-- Offcanvas: Incident Details Panel -->
  <div aria-labelledby="incidentDetailsLabel" class="offcanvas offcanvas-end" id="incidentDetailsPanel" tabindex="-1">
   <div class="offcanvas-header">
    <h5 class="mb-0" id="incidentDetailsLabel">
     Incident Details
    </h5>
    <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
    </button>
   </div>
   <div class="offcanvas-body d-flex flex-column">
    <div id="incidentDetailsContent">
     <div class="text-center py-4 text-muted">
      Select an incident from the map or feed.
     </div>
    </div>
    <div class="mt-auto pt-3 border-top">
     <div class="d-flex gap-2 align-items-end">
      <div class="flex-fill">
       <label class="form-label" for="statusUpdater">
        Update Status
       </label>
       <select class="form-select" disabled="" id="statusUpdater">
        <option>
         New
        </option>
        <option>
         In Progress
        </option>
        <option>
         Resolved
        </option>
       </select>
      </div>
      <button class="btn btn-primary" disabled="" id="btnSaveStatus">
       <i class="fa-solid fa-floppy-disk me-1">
       </i>
       Save Status
      </button>
     </div>
    </div>
   </div>
  </div>
  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
   <div aria-atomic="true" aria-live="polite" class="toast align-items-center text-bg-dark border-0" id="appToast" role="status">
    <div class="d-flex">
     <div class="toast-body" id="toastBody">
      Action completed.
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- Dependencies: Bootstrap JS, SweetAlert2, Leaflet, Chart.js -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.all.min.js">
  </script>
  <script crossorigin="" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js">
  </script>
  <script>
   // State
let allIncidents = [];
let filteredIncidents = [];
let selectedIncidentId = null;

// Pagination state
const FEED_PAGE_SIZE = 5;
const TABLE_PAGE_SIZE = 6;
let feedPage = 1;
let tablePage = 1;

// Map
let map, markersLayer;

// Offcanvas instance
const offcanvasEl = document.getElementById('incidentDetailsPanel');
const offcanvas = new bootstrap.Offcanvas(offcanvasEl);

// Toast
const appToast = new bootstrap.Toast(document.getElementById('appToast'));

// Colors by type
const typeColors = {
    Fire: {
        color: '#DC3545',
        fill: '#FAD1D6'
    },
    Flood: {
        color: '#0099D2',
        fill: '#D1EEF9'
    },
    Earthquake: {
        color: '#FFC107',
        fill: '#FFF3CD'
    },
    Storm: {
        color: '#6C757D',
        fill: '#E9ECEF'
    },
    Landslide: {
        color: '#28A745',
        fill: '#E9F6EC'
    }
};

// Mock data generation (stable)
function mockIncidents() {
    const now = Date.now();
    const base = [{
        id: 'INC1001',
        title: 'Warehouse Fire - Dockside',
        type: 'Fire',
        severity: 4,
        status: 'In Progress',
        lat: 37.788,
        lng: -122.407,
        ts: now - 30 * 60 * 1000,
        volunteers: 12
    }, {
        id: 'INC1002',
        title: 'River Overflow near 5th Ave',
        type: 'Flood',
        severity: 3,
        status: 'New',
        lat: 37.782,
        lng: -122.42,
        ts: now - 60 * 60 * 1000,
        volunteers: 6
    }, {
        id: 'INC1003',
        title: 'Aftershock Structural Crack',
        type: 'Earthquake',
        severity: 2,
        status: 'Resolved',
        lat: 37.774,
        lng: -122.431,
        ts: now - 3 * 60 * 60 * 1000,
        volunteers: 2
    }, {
        id: 'INC1004',
        title: 'Treefall & Power Lines',
        type: 'Storm',
        severity: 3,
        status: 'In Progress',
        lat: 37.768,
        lng: -122.447,
        ts: now - 90 * 60 * 1000,
        volunteers: 4
    }, {
        id: 'INC1005',
        title: 'Hillside Slide - West Ridge',
        type: 'Landslide',
        severity: 5,
        status: 'New',
        lat: 37.759,
        lng: -122.45,
        ts: now - 15 * 60 * 1000,
        volunteers: 10
    }, {
        id: 'INC1006',
        title: 'Residential Fire - Elm St',
        type: 'Fire',
        severity: 2,
        status: 'Resolved',
        lat: 37.77,
        lng: -122.404,
        ts: now - 6 * 60 * 60 * 1000,
        volunteers: 3
    }, {
        id: 'INC1007',
        title: 'Storm Surge - Marina',
        type: 'Flood',
        severity: 4,
        status: 'In Progress',
        lat: 37.806,
        lng: -122.439,
        ts: now - 2 * 60 * 60 * 1000,
        volunteers: 7
    }, {
        id: 'INC1008',
        title: 'Overpass Crack - I-80',
        type: 'Earthquake',
        severity: 3,
        status: 'New',
        lat: 37.799,
        lng: -122.397,
        ts: now - 25 * 60 * 1000,
        volunteers: 5
    }, {
        id: 'INC1009',
        title: 'Wind Damage - Sunset',
        type: 'Storm',
        severity: 2,
        status: 'Resolved',
        lat: 37.753,
        lng: -122.483,
        ts: now - 8 * 60 * 60 * 1000,
        volunteers: 0
    }, {
        id: 'INC1010',
        title: 'Creek Rising - North Point',
        type: 'Flood',
        severity: 1,
        status: 'New',
        lat: 37.81,
        lng: -122.41,
        ts: now - 50 * 60 * 1000,
        volunteers: 1
    }];
    // add details and media
    return base.map(i => ({
        ...i,
        description: `${i.title} reported by field teams. Severity level ${i.severity}. Ongoing assessment and response coordination.`,
        media: [{
            url: 'https://picsum.photos/seed/' + i.id + '/640/360',
            alt: i.title
        }],
        address: 'Sample address near coordinates',
    }));
}

function formatTime(ts) {
    const d = new Date(ts);
    return d.toLocaleString();
}

function statusBadge(status) {
    const map = {
        'New': 'badge-soft warning',
        'In Progress': 'badge-soft info',
        'Resolved': 'badge-soft success'
    };
    const cls = map[status] || 'badge-soft';
    return `<span class="${cls}">${status}</span>`;
}

function severityBadge(sev) {
    const palette = {
        1: 'bg-secondary',
        2: 'bg-info',
        3: 'bg-warning',
        4: 'bg-danger',
        5: 'bg-danger'
    };
    const cls = palette[sev] || 'bg-secondary';
    return `<span class="badge ${cls}">S${sev}</span>`;
}

// Initialize Map
function initMap() {
    map = L.map('incidentMap', {
        scrollWheelZoom: true
    }).setView([37.78, -122.435], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
}

function renderMarkers(list) {
    markersLayer.clearLayers();
    list.forEach(inc => {
        const col = typeColors[inc.type] || {
            color: '#6C757D',
            fill: '#E9ECEF'
        };
        const radius = 6 + inc.severity * 3;
        const marker = L.circleMarker([inc.lat, inc.lng], {
            color: col.color,
            fillColor: col.color,
            fillOpacity: 0.2 + inc.severity * 0.1,
            radius,
            weight: 2
        }).addTo(markersLayer);
        marker.bindTooltip(`${inc.title} (${inc.type}) - S${inc.severity}`);
        marker.on('click', () => onIncidentSelect(inc.id));
    });
}

// Filtering
function getActiveFilters() {
    const types = Array.from(document.querySelectorAll('.disaster-type:checked')).map(i => i.value);
    const status = document.getElementById('statusFilter').value;
    const severityMin = parseInt(document.getElementById('severityFilter').value || '0', 10);
    const from = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value).getTime() : null;
    const to = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value).getTime() + 24 * 60 * 60 * 1000 - 1 : null;
    return {
        types,
        status,
        severityMin,
        from,
        to
    };
}

function applyFilters() {
    const f = getActiveFilters();
    filteredIncidents = allIncidents.filter(inc => {
        if (f.types.length && !f.types.includes(inc.type)) return false;
        if (f.status !== 'All' && inc.status !== f.status) return false;
        if (inc.severity < f.severityMin) return false;
        if (f.from && inc.ts < f.from) return false;
        if (f.to && inc.ts > f.to) return false;
        return true;
    });
    feedPage = 1;
    tablePage = 1;
    renderMarkers(filteredIncidents);
    renderFeed();
    renderTable();
    renderMetrics();
    renderTypeChart();
}

// Feed rendering
function renderFeed() {
    const container = document.getElementById('incidentFeed');
    container.innerHTML = '';
    const start = (feedPage - 1) * FEED_PAGE_SIZE;
    const pageItems = filteredIncidents.slice(start, start + FEED_PAGE_SIZE);
    if (pageItems.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="text-muted">No incidents match your filters.</div></div>`;
    } else {
        pageItems.forEach(inc => {
            const card = document.createElement('div');
            card.className = `card incident-card ${inc.id === selectedIncidentId ? 'card-selected' : ''}`;
            card.innerHTML = `
            <div class="card-body d-flex gap-3">
              <div class="flex-shrink-0">
                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:44px;height:44px;background:${(typeColors[inc.type]||{}).fill || '#eee'};border:2px solid ${(typeColors[inc.type]||{}).color || '#999'};">
                  <i class="${iconForType(inc.type)}"></i>
                </div>
              </div>
              <div class="flex-fill">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="mb-1">${inc.title}</h6>
                  <div>${severityBadge(inc.severity)}</div>
                </div>
                <div class="small text-muted mb-1">${inc.type} • ${formatTime(inc.ts)}</div>
                <div>${statusBadge(inc.status)}</div>
              </div>
            </div>`;
            card.addEventListener('click', () => onIncidentSelect(inc.id));
            container.appendChild(card);
        });
    }
    // Pagination controls
    const totalPages = Math.max(1, Math.ceil(filteredIncidents.length / FEED_PAGE_SIZE));
    document.getElementById('feedPageInfo').textContent = `Page ${feedPage} of ${totalPages}`;
    document.getElementById('feedPrev').disabled = feedPage <= 1;
    document.getElementById('feedNext').disabled = feedPage >= totalPages;
}

// Table rendering
function renderTable(sortBy, direction) {
    let list = [...filteredIncidents];
    if (sortBy) {
        list.sort((a, b) => {
            let va = a[sortBy],
                vb = b[sortBy];
            if (sortBy === 'timestamp') {
                va = a.ts;
                vb = b.ts;
            }
            if (va < vb) return direction === 'asc' ? -1 : 1;
            if (va > vb) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }
    const start = (tablePage - 1) * TABLE_PAGE_SIZE;
    const pageItems = list.slice(start, start + TABLE_PAGE_SIZE);
    const tbody = document.getElementById('incidentsTableBody');
    tbody.innerHTML = '';
    if (pageItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No incidents to display.</td></tr>`;
    } else {
        pageItems.forEach(inc => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td><a href="#" class="fw-semibold incident-link" data-id="${inc.id}">${inc.title}</a></td>
            <td>${inc.type}</td>
            <td>${severityBadge(inc.severity)}</td>
            <td>${statusBadge(inc.status)}</td>
            <td><span class="small text-muted">${formatTime(inc.ts)}</span></td>
            <td>
              <button class="btn btn-sm btn-light me-1 view-btn" data-id="${inc.id}"><i class="fa-regular fa-eye"></i></button>
              <button class="btn btn-sm btn-primary update-btn" data-id="${inc.id}"><i class="fa-solid fa-pen-to-square"></i></button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    // Pagination info
    const totalPages = Math.max(1, Math.ceil(list.length / TABLE_PAGE_SIZE));
    document.getElementById('tablePageInfo').textContent = `Page ${tablePage} of ${totalPages}`;
    document.getElementById('tablePrev').disabled = tablePage <= 1;
    document.getElementById('tableNext').disabled = tablePage >= totalPages;

    // Row actions
    tbody.querySelectorAll('.view-btn, .incident-link').forEach(el => el.addEventListener('click', (e) => {
        e.preventDefault();
        const id = e.currentTarget.getAttribute('data-id');
        onIncidentSelect(id);
    }));
    tbody.querySelectorAll('.update-btn').forEach(el => el.addEventListener('click', (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        onIncidentSelect(id);
        // Focus status dropdown
        setTimeout(() => document.getElementById('statusUpdater').focus(), 300);
    }));
}

// Metrics and chart
function renderMetrics() {
    const total = filteredIncidents.length;
    const active = filteredIncidents.filter(i => i.status === 'New' || i.status === 'In Progress').length;
    const volunteers = filteredIncidents.reduce((sum, i) => sum + (i.volunteers || 0), 0);
    document.getElementById('metricTotal').textContent = total.toString();
    document.getElementById('metricActive').textContent = active.toString();
    document.getElementById('metricVolunteers').textContent = volunteers.toString();
}

let typeChart;

function renderTypeChart() {
    const counts = {
        Fire: 0,
        Flood: 0,
        Earthquake: 0,
        Storm: 0,
        Landslide: 0
    };
    filteredIncidents.forEach(i => counts[i.type] = (counts[i.type] || 0) + 1);
    const ctx = document.getElementById('typeBarChart');
    const labels = Object.keys(counts);
    const data = Object.values(counts);
    const bg = labels.map(l => (typeColors[l] || {
        color: '#6C757D'
    }).color);
    if (typeChart) {
        typeChart.destroy();
    }
    typeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Incidents',
                data,
                backgroundColor: bg
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Select incident and open details panel
function onIncidentSelect(id) {
    selectedIncidentId = id;
    const inc = allIncidents.find(i => i.id === id);
    if (!inc) return;
    renderFeed(); // highlight selection
    // Populate details
    const el = document.getElementById('incidentDetailsContent');
    el.innerHTML = `
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <h5 class="mb-1">${inc.title}</h5>
            <div class="mb-2">${severityBadge(inc.severity)} ${statusBadge(inc.status)}</div>
            <div class="text-muted small"><i class="fa-regular fa-clock me-1"></i> ${formatTime(inc.ts)}</div>
            <div class="text-muted small"><i class="fa-solid fa-location-dot me-1"></i> ${inc.address}</div>
          </div>
          <div class="text-end">
            <span class="badge-soft ${badgeClassForType(inc.type)}">${inc.type}</span>
          </div>
        </div>
        <div class="mt-3">
          <img src="${inc.media[0].url}" alt="${inc.title}" class="img-fluid rounded" onerror="this.onerror=null;this.src='https://picsum.photos/seed/${encodeURIComponent(inc.id)}/640/360'" />
        </div>
        <p class="mt-3">${inc.description}</p>
        <div class="row g-2 small">
          <div class="col-6"><i class="fa-solid fa-users me-1 text-success"></i> Volunteers: <strong>${inc.volunteers || 0}</strong></div>
          <div class="col-6"><i class="fa-solid fa-hashtag me-1 text-muted"></i> ID: <strong>${inc.id}</strong></div>
        </div>
      `;

    // Status updater
    const upd = document.getElementById('statusUpdater');
    upd.value = inc.status;
    upd.disabled = false;
    document.getElementById('btnSaveStatus').disabled = true;

    // Listen for changes
    upd.onchange = () => {
        document.getElementById('btnSaveStatus').disabled = (upd.value === inc.status);
    };

    offcanvas.show();
}

function badgeClassForType(type) {
    switch (type) {
        case 'Fire':
            return 'error';
        case 'Flood':
            return 'info';
        case 'Earthquake':
            return 'warning';
        case 'Storm':
            return 'secondary';
        case 'Landslide':
            return 'success';
        default:
            return '';
    }
}

function iconForType(type) {
    switch (type) {
        case 'Fire':
            return 'fa-solid fa-fire text-danger';
        case 'Flood':
            return 'fa-solid fa-water text-info';
        case 'Earthquake':
            return 'fa-solid fa-house-crack text-warning';
        case 'Storm':
            return 'fa-solid fa-cloud-bolt text-secondary';
        case 'Landslide':
            return 'fa-solid fa-mountain text-success';
        default:
            return 'fa-regular fa-circle';
    }
}

// Save status logic (simulated API call)
function saveStatus() {
    const id = selectedIncidentId;
    if (!id) return;
    const inc = allIncidents.find(i => i.id === id);
    const newStatus = document.getElementById('statusUpdater').value;
    if (newStatus === inc.status) return;

    // Simulate API call
    document.getElementById('btnSaveStatus').disabled = true;
    Swal.fire({
        title: 'Updating status...',
        html: 'Please wait',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    setTimeout(() => {
        inc.status = newStatus;
        Swal.close();
        Swal.fire({
            icon: 'success',
            title: 'Status updated',
            timer: 1400,
            showConfirmButton: false
        });
        applyFilters();
        // Keep panel open with refreshed data
        onIncidentSelect(id);
    }, 800);
}

// Search handler
function handleGlobalSearch(term) {
    term = term.toLowerCase();
    filteredIncidents = allIncidents.filter(i => {
        return i.title.toLowerCase().includes(term) || i.type.toLowerCase().includes(term) || i.status.toLowerCase().includes(term);
    });
    feedPage = 1;
    tablePage = 1;
    renderMarkers(filteredIncidents);
    renderFeed();
    renderTable();
    renderMetrics();
    renderTypeChart();
}

// Event bindings
function bindEvents() {
    document.getElementById('btnApplyFilters').addEventListener('click', applyFilters);
    document.getElementById('btnClearFilters').addEventListener('click', () => {
        document.querySelectorAll('.disaster-type').forEach(cb => cb.checked = true);
        document.getElementById('statusFilter').value = 'All';
        document.getElementById('severityFilter').value = '0';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        applyFilters();
    });
    document.getElementById('btnResetFilters').addEventListener('click', () => {
        document.getElementById('btnClearFilters').click();
    });
    document.querySelectorAll('.disaster-type, #statusFilter, #severityFilter, #dateFrom, #dateTo').forEach(el => {
        el.addEventListener('change', applyFilters);
    });
    document.getElementById('feedPrev').addEventListener('click', () => {
        if (feedPage > 1) {
            feedPage--;
            renderFeed();
        }
    });
    document.getElementById('feedNext').addEventListener('click', () => {
        const max = Math.ceil(filteredIncidents.length / FEED_PAGE_SIZE);
        if (feedPage < max) {
            feedPage++;
            renderFeed();
        }
    });
    document.getElementById('tablePrev').addEventListener('click', () => {
        if (tablePage > 1) {
            tablePage--;
            renderTable();
        }
    });
    document.getElementById('tableNext').addEventListener('click', () => {
        const max = Math.ceil(filteredIncidents.length / TABLE_PAGE_SIZE);
        if (tablePage < max) {
            tablePage++;
            renderTable();
        }
    });
    document.querySelectorAll('#incidentsTable thead .sortable').forEach(th => {
        let dir = 'asc';
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            dir = dir === 'asc' ? 'desc' : 'asc';
            renderTable(key, dir);
        });
    });
    document.getElementById('btnSaveStatus').addEventListener('click', saveStatus);
    document.getElementById('btnResetMap').addEventListener('click', () => {
        map.setView([37.78, -122.435], 12);
    });
    document.getElementById('btnRefresh').addEventListener('click', (e) => {
        e.preventDefault();
        // Simulate refresh (shuffle volunteer counts)
        allIncidents.forEach(i => i.volunteers = Math.max(0, i.volunteers + (Math.floor(Math.random() * 3) - 1)));
        applyFilters();
        showToast('Data refreshed');
    });
    document.getElementById('globalSearchInput').addEventListener('input', (e) => handleGlobalSearch(e.target.value));
}

function showToast(msg) {
    document.getElementById('toastBody').textContent = msg;
    appToast.show();
}

// Init
window.addEventListener('DOMContentLoaded', () => {
    try {
        document.getElementById('headerUserName').textContent = 'Alex Johnson';
        document.getElementById('sidebarUserName').textContent = 'Alex Johnson';
    } catch {}
    initMap();
    allIncidents = mockIncidents();
    filteredIncidents = [...allIncidents];
    bindEvents();
    applyFilters();
});
  </script>
 </body>
</html>
