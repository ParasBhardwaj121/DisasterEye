<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Profile Settings - DisasterEye
  </title>
  <!-- Brand font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.min.css" rel="stylesheet"/>
  <!-- Global Theme Styles -->
  <link href="style.css" rel="stylesheet"/>
  <!-- Page specific CSS -->
  <link href="profile_settings.css" rel="stylesheet"/>
 </head>
 <body class="view-grid">
  <!-- Header: Common Info & Account Header -->
  <header class="navbar navbar-expand bg-white border-bottom shadow-sm" style="--primary:#FF0000; --secondary:#FFD700;">
   <div class="container-fluid">
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle sidebar" class="btn d-md-none" data-bs-target="#sidebarMenu" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center gap-2" href="./individual_dashboard.html">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/disastereye-logo/48/48'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:28px;"/>
     <span class="fw-bold" style="color:var(--primary)">
      DisasterEye
     </span>
    </a>
    <form class="ms-auto me-3 d-none d-md-block" role="search" style="max-width:360px;">
     <div class="input-group">
      <span class="input-group-text bg-white">
       <i class="fa-solid fa-magnifying-glass text-muted">
       </i>
      </span>
      <input aria-label="Search" class="form-control" placeholder="Search incidents, alerts, guides..." type="search"/>
     </div>
    </form>
    <ul class="navbar-nav ms-auto align-items-center">
     <li class="nav-item me-2">
      <a class="nav-link position-relative" href="./notification_settings.html" title="Notifications">
       <i class="fa-solid fa-bell">
       </i>
       <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" style="background-color:#FF0000;">
        3
       </span>
      </a>
     </li>
     <li class="nav-item dropdown">
      <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" role="button">
       <i class="fa-solid fa-user-circle me-2">
       </i>
       <span id="headerUserName">
        Alex Morgan
       </span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
       <li>
        <a class="dropdown-item" href="./profile_settings.html">
         <i class="fa-solid fa-gear me-2">
         </i>
         Settings
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <a class="dropdown-item text-danger" href="./login_page.html">
         <i class="fa-solid fa-right-from-bracket me-2">
         </i>
         Logout
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </div>
  </header>
  <div class="d-flex" style="min-height:100vh;">
   <!-- Sidebar: Common Info & Account Sidebar -->
   <nav class="collapse d-md-block bg-white border-end" id="sidebarMenu" style="min-height:100vh; width:280px;">
    <div class="position-sticky">
     <div class="p-3 border-bottom d-flex align-items-center gap-2">
      <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/de-logo/40/40'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:32px;"/>
      <span class="fw-bold">
       DisasterEye
      </span>
     </div>
     <div class="p-3">
      <div class="d-flex align-items-center gap-2 mb-3">
       <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
        <i class="fa-solid fa-user text-secondary">
        </i>
       </div>
       <div>
        <div class="fw-semibold" id="sidebarUserName">
         Alex Morgan
        </div>
        <div class="badge" id="sidebarRole" style="background-color:#FFD700; color:#000;">
         Individual
        </div>
       </div>
      </div>
      <ul class="nav nav-pills flex-column gap-1">
       <li class="nav-item">
        <a class="nav-link d-flex align-items-center active" href="./profile_settings.html">
         <i class="fa-solid fa-user-gear me-2 text-danger">
         </i>
         Profile Settings
        </a>
       </li>
       <li class="nav-item">
        <a class="nav-link d-flex align-items-center" href="./safety_guides.html">
         <i class="fa-solid fa-shield-heart me-2 text-danger">
         </i>
         Safety Guides
        </a>
       </li>
       <li class="nav-item">
        <button aria-expanded="true" class="btn w-100 text-start nav-link d-flex align-items-center" data-bs-target="#alertsMenu" data-bs-toggle="collapse">
         <i class="fa-solid fa-triangle-exclamation me-2 text-danger">
         </i>
         Alerts &amp; Incidents
         <i class="fa-solid fa-chevron-down ms-auto small">
         </i>
        </button>
        <div class="collapse show ps-3" id="alertsMenu">
         <ul class="nav flex-column gap-1">
          <li class="nav-item">
           <a class="nav-link" href="./alert_details.html">
            <i class="fa-solid fa-map me-2 text-muted">
            </i>
            Alert Details
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link" href="./incident_details.html">
            <i class="fa-solid fa-clipboard-list me-2 text-muted">
            </i>
            Incident Details
           </a>
          </li>
         </ul>
        </div>
       </li>
      </ul>
     </div>
    </div>
   </nav>
   <!-- Main Content -->
   <main class="flex-grow-1 main-panel">
    <div class="container-fluid">
     <!-- Breadcrumb -->
     <nav aria-label="breadcrumb" class="breadcrumb mb-2">
      <ol class="breadcrumb mb-0">
       <li class="breadcrumb-item">
        <a href="./individual_dashboard.html">
         <i class="fa-solid fa-house me-1">
         </i>
         Home
        </a>
       </li>
       <li aria-current="page" class="breadcrumb-item active">
        Profile Settings
       </li>
      </ol>
     </nav>
     <!-- Page Header -->
     <div class="page-header">
      <div class="d-flex align-items-center gap-3">
       <h1 class="page-title mb-0">
        Profile Settings
       </h1>
       <span class="badge-soft info">
        <i class="fa-solid fa-shield-halved me-1">
        </i>
        Secure your account
       </span>
      </div>
      <div aria-label="View switcher" class="view-switcher" role="group">
       <div class="option active" data-view="view-grid">
        <i class="fa-solid fa-grip">
        </i>
       </div>
       <div class="option" data-view="view-table">
        <i class="fa-solid fa-list">
        </i>
       </div>
       <div class="option" data-view="view-tiles">
        <i class="fa-solid fa-table-cells">
        </i>
       </div>
      </div>
     </div>
     <!-- Feedback area -->
     <div class="d-none" id="systemFeedback">
      <div class="alert alert-info d-flex align-items-center" role="alert">
       <i class="fa-solid fa-circle-info me-2">
       </i>
       <div id="systemFeedbackText">
        Loading your profile...
       </div>
      </div>
     </div>
     <div class="grid auto-fit-lg">
      <!-- Personal Information -->
      <section aria-labelledby="personalInfoHeader" class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-id-card-clip text-primary">
         </i>
         <span class="widget-title" id="personalInfoHeader">
          Personal Information
         </span>
        </div>
        <button class="btn btn-primary btn-sm" disabled="" id="btnSavePersonal">
         <i class="fa-solid fa-floppy-disk me-1">
         </i>
         Save Changes
        </button>
       </div>
       <div class="card-body">
        <form id="personalInfoForm" novalidate="">
         <div class="row g-3">
          <div class="col-md-6">
           <label class="form-label">
            Full Name
            <span class="text-danger">
             *
            </span>
           </label>
           <input class="form-control" id="piName" placeholder="e.g., Jordan Lee" required="" type="text"/>
           <div class="invalid-feedback">
            Name is required.
           </div>
          </div>
          <div class="col-md-6">
           <label class="form-label">
            Email Address
           </label>
           <input class="form-control" id="piEmail" readonly="" type="email"/>
           <div class="form-text">
            Email is your username and cannot be changed.
           </div>
          </div>
          <div class="col-md-6">
           <label class="form-label">
            Phone Number
           </label>
           <input class="form-control" id="piPhone" pattern="^\+?[1-9]\d{1,14}$" placeholder="e.g., +15551234567" type="tel"/>
           <div class="form-text">
            Use E.164 format. Example: +15551234567
           </div>
           <div class="invalid-feedback">
            Please enter a valid phone number in E.164 format.
           </div>
          </div>
          <div class="col-md-6">
           <label class="form-label">
            Primary Location
           </label>
           <input class="form-control" id="piLocation" placeholder="City, State / Region" type="text"/>
           <div class="form-text">
            Used for localized alerts and notifications.
           </div>
          </div>
         </div>
        </form>
        <div class="mt-3 d-none" id="personalInfoLoading">
         <div class="skeleton mb-2" style="height:14px; max-width:280px;">
         </div>
         <div class="skeleton mb-2" style="height:14px; max-width:340px;">
         </div>
         <div class="skeleton" style="height:14px; max-width:220px;">
         </div>
        </div>
       </div>
      </section>
      <!-- Security Settings -->
      <section aria-labelledby="securityHeader" class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-lock text-danger">
         </i>
         <span class="widget-title" id="securityHeader">
          Security Settings
         </span>
        </div>
        <button class="btn btn-danger btn-sm" disabled="" id="btnUpdatePassword">
         <i class="fa-solid fa-key me-1">
         </i>
         Update Password
        </button>
       </div>
       <div class="card-body">
        <form id="securityForm" novalidate="">
         <div class="row g-3">
          <div class="col-12">
           <label class="form-label">
            Current Password
            <span class="text-danger">
             *
            </span>
           </label>
           <div class="input-group">
            <input autocomplete="current-password" class="form-control" id="curPwd" required="" type="password"/>
            <span class="input-group-text bg-white toggle-visibility-icon" data-target="curPwd" role="button" title="Show/Hide">
             <i class="fa-regular fa-eye">
             </i>
            </span>
            <div class="invalid-feedback">
             Current password is required.
            </div>
           </div>
          </div>
          <div class="col-md-6">
           <label class="form-label">
            New Password
            <span class="text-danger">
             *
            </span>
           </label>
           <div class="input-group">
            <input aria-describedby="pwdHelp" autocomplete="new-password" class="form-control" id="newPwd" required="" type="password"/>
            <span class="input-group-text bg-white toggle-visibility-icon" data-target="newPwd" role="button" title="Show/Hide">
             <i class="fa-regular fa-eye">
             </i>
            </span>
            <div class="invalid-feedback">
             Please enter a valid password.
            </div>
           </div>
           <div class="form-text" id="pwdHelp">
            Min 8 chars, mix of upper, lower, number, symbol.
           </div>
          </div>
          <div class="col-md-6">
           <label class="form-label">
            Confirm New Password
            <span class="text-danger">
             *
            </span>
           </label>
           <div class="input-group">
            <input autocomplete="new-password" class="form-control" id="confPwd" required="" type="password"/>
            <span class="input-group-text bg-white toggle-visibility-icon" data-target="confPwd" role="button" title="Show/Hide">
             <i class="fa-regular fa-eye">
             </i>
            </span>
            <div class="invalid-feedback">
             Passwords must match.
            </div>
           </div>
          </div>
          <div class="col-12">
           <label class="form-label mb-1">
            Password Strength
           </label>
           <div class="progress">
            <div class="progress-bar" id="pwdStrengthBar" style="width: 0%">
            </div>
           </div>
           <div class="d-flex align-items-center gap-2 mt-1">
            <small class="text-muted" id="pwdStrengthText">
             Too weak
            </small>
            <span class="badge-soft warning" id="pwdRulesBadge">
             <i class="fa-solid fa-list-check me-1">
             </i>
             Follow the rules
            </span>
           </div>
          </div>
         </div>
        </form>
        <div class="mt-3 d-flex align-items-center gap-2">
         <i class="fa-solid fa-circle-info text-info">
         </i>
         <small class="text-muted">
          Tip: Use a passphrase (4+ random words) for strong yet memorable passwords.
         </small>
        </div>
       </div>
      </section>
      <!-- Emergency Contacts Manager -->
      <section aria-labelledby="contactsHeader" class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-user-shield text-success">
         </i>
         <span class="widget-title" id="contactsHeader">
          Emergency Contacts
         </span>
        </div>
        <div class="d-flex align-items-center gap-2">
         <div class="input-group input-group-sm" style="min-width:260px;">
          <span class="input-group-text bg-white">
           <i class="fa-solid fa-magnifying-glass text-muted">
           </i>
          </span>
          <input class="form-control" id="contactsSearch" placeholder="Search contacts by name or phone" type="search"/>
         </div>
        </div>
       </div>
       <div class="card-body">
        <form class="row g-2 align-items-end" id="addContactForm" novalidate="">
         <div class="col-md-4">
          <label class="form-label">
           Name
           <span class="text-danger">
            *
           </span>
          </label>
          <input class="form-control" id="newContactName" placeholder="e.g., Taylor Reed" required="" type="text"/>
          <div class="invalid-feedback">
           Name is required.
          </div>
         </div>
         <div class="col-md-4">
          <label class="form-label">
           Phone
           <span class="text-danger">
            *
           </span>
          </label>
          <input class="form-control" id="newContactPhone" pattern="^\+?[1-9]\d{1,14}$" placeholder="e.g., +15557654321" required="" type="tel"/>
          <div class="invalid-feedback">
           Enter a valid phone in E.164 format.
          </div>
         </div>
         <div class="col-md-4">
          <button class="btn btn-success" disabled="" id="btnAddContact" type="submit">
           <i class="fa-solid fa-user-plus me-1">
           </i>
           Add Contact
          </button>
         </div>
        </form>
        <div class="table-responsive mt-4">
         <table class="table table-theme align-middle" id="contactsTable">
          <thead>
           <tr>
            <th class="sortable" data-sort="name" role="button">
             Name
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable" data-sort="phone" role="button">
             Phone
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="sortable" data-sort="added" role="button">
             Added On
             <i class="fa-solid fa-sort ms-1 text-muted">
             </i>
            </th>
            <th class="text-end">
             Actions
            </th>
           </tr>
          </thead>
          <tbody id="contactsTbody">
           <!-- Rows injected via JS -->
          </tbody>
         </table>
        </div>
        <div class="d-flex align-items-center justify-content-between mt-2">
         <small class="text-muted" id="contactsSummary">
          Showing 0 of 0
         </small>
         <nav>
          <ul class="pagination pagination-sm mb-0" id="contactsPagination">
           <!-- Pagination injected -->
          </ul>
         </nav>
        </div>
       </div>
      </section>
      <!-- Optional: Recent Login Activity (Chart) -->
      <section aria-labelledby="activityHeader" class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-chart-line text-info">
         </i>
         <span class="widget-title" id="activityHeader">
          Recent Login Activity (7 days)
         </span>
        </div>
       </div>
       <div class="card-body">
        <canvas aria-label="Login activity chart" height="140" id="loginActivityChart" role="img">
        </canvas>
        <div class="mt-2 d-flex align-items-center gap-2">
         <span class="status-dot success">
         </span>
         <small class="text-muted">
          Successful logins
         </small>
        </div>
       </div>
      </section>
     </div>
     <!-- Toasts Container -->
     <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
      <div aria-atomic="true" aria-live="assertive" class="toast align-items-center text-bg-light border" id="actionToast" role="alert">
       <div class="d-flex">
        <div class="toast-body" id="toastBody">
         Updated successfully.
        </div>
        <button aria-label="Close" class="btn-close me-2 m-auto" data-bs-dismiss="toast" type="button">
        </button>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Footer: Common Info & Account Footer -->
  <footer class="border-top bg-light">
   <div class="container py-3 d-flex flex-wrap align-items-center justify-content-between small">
    <div class="d-flex align-items-center gap-2">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/de-footer/36/36'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:18px;"/>
     <span class="text-muted">
      DisasterEye
     </span>
    </div>
    <ul class="nav align-items-center">
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="./report_generator.html">
       Reports
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="./alert_monitoring.html">
       Monitoring
      </a>
     </li>
     <li class="nav-item d-none d-md-block">
      <a class="btn btn-outline-danger btn-sm ms-2" href="./incident_report.html">
       <i class="fa-solid fa-flag me-1">
       </i>
       Report Issue
      </a>
     </li>
    </ul>
   </div>
  </footer>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js">
  </script>
  <script>
   // State
const state = {
    user: {
        id: 'u_1001',
        name: 'Alex Morgan',
        email: 'alex.morgan@example.com',
        phone: '+15551234567',
        location: 'San Francisco, CA',
        role: 'Individual'
    },
    contacts: [],
    contactPage: 1,
    pageSize: 5,
    sort: {
        key: 'name',
        dir: 'asc'
    },
    filter: ''
};

// Mock: initial contacts
const initialContacts = [{
    id: 'c1',
    name: 'Taylor Reed',
    phone: '+15557654321',
    added: dayjs().subtract(1, 'day').toISOString()
}, {
    id: 'c2',
    name: 'Jordan Lee',
    phone: '+15553456789',
    added: dayjs().subtract(3, 'day').toISOString()
}, {
    id: 'c3',
    name: 'Riley Chen',
    phone: '+447911123456',
    added: dayjs().subtract(10, 'day').toISOString()
}, {
    id: 'c4',
    name: 'Samira Khan',
    phone: '+971501234567',
    added: dayjs().subtract(2, 'day').toISOString()
}, {
    id: 'c5',
    name: 'Diego Alvarez',
    phone: '+5215512345678',
    added: dayjs().subtract(5, 'day').toISOString()
}, {
    id: 'c6',
    name: 'Ava Patel',
    phone: '+61400111222',
    added: dayjs().subtract(8, 'day').toISOString()
}, {
    id: 'c7',
    name: 'Noah Williams',
    phone: '+15559876543',
    added: dayjs().subtract(12, 'day').toISOString()
}, {
    id: 'c8',
    name: 'Mia Rossi',
    phone: '+393331234567',
    added: dayjs().subtract(15, 'day').toISOString()
}];

// Utilities
const qs = (s, root = document) => root.querySelector(s);
const qsa = (s, root = document) => Array.from(root.querySelectorAll(s));
const showToast = (msg) => {
    const toastEl = qs('#actionToast');
    qs('#toastBody').textContent = msg;
    const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
    toast.show();
};
const e164 = /^\+?[1-9]\d{1,14}$/;

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Load user
    loadUser();
    // Init events
    initPersonalInfoForm();
    initSecurityForm();
    initContacts();
    initViewSwitcher();
    initChart();
    initTooltips();
});

function initTooltips() {
    qsa('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
}

function setFeedback(visible, text = '') {
    const wrap = qs('#systemFeedback');
    qs('#systemFeedbackText').textContent = text;
    wrap.classList.toggle('d-none', !visible);
}

function loadUser() {
    setFeedback(true, 'Loading your profile...');
    qs('#personalInfoLoading').classList.remove('d-none');
    // Simulate fetch delay
    setTimeout(() => {
        // Set header/sidebar
        qs('#headerUserName').textContent = state.user.name;
        qs('#sidebarUserName').textContent = state.user.name;
        qs('#sidebarRole').textContent = state.user.role;
        // Populate form
        qs('#piName').value = state.user.name;
        qs('#piEmail').value = state.user.email;
        qs('#piPhone').value = state.user.phone;
        qs('#piLocation').value = state.user.location;

        qs('#personalInfoLoading').classList.add('d-none');
        setFeedback(false);
    }, 800);
}

// Personal Info Form
function initPersonalInfoForm() {
    const form = qs('#personalInfoForm');
    const btn = qs('#btnSavePersonal');
    const inputs = ['#piName', '#piPhone', '#piLocation'].map(q => qs(q));

    function validate() {
        // Name required
        const nameValid = qs('#piName').value.trim().length > 0;
        qs('#piName').classList.toggle('is-invalid', !nameValid);
        // Phone optional but if present must match E.164
        const phone = qs('#piPhone').value.trim();
        const phoneValid = phone === '' || e164.test(phone);
        qs('#piPhone').classList.toggle('is-invalid', !phoneValid);
        // Determine if changed
        const changed = (
            qs('#piName').value.trim() !== state.user.name ||
            qs('#piPhone').value.trim() !== state.user.phone ||
            qs('#piLocation').value.trim() !== state.user.location
        );
        btn.disabled = !(nameValid && phoneValid && changed);
    }

    inputs.forEach(el => el.addEventListener('input', validate));

    qs('#btnSavePersonal').addEventListener('click', async () => {
        if (btn.disabled) return;
        // Simulate save
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving';
        await new Promise(r => setTimeout(r, 900));

        // Update state
        state.user.name = qs('#piName').value.trim();
        state.user.phone = qs('#piPhone').value.trim();
        state.user.location = qs('#piLocation').value.trim();
        qs('#headerUserName').textContent = state.user.name;
        qs('#sidebarUserName').textContent = state.user.name;

        btn.innerHTML = '<i class="fa-solid fa-floppy-disk me-1"></i> Save Changes';
        showToast('Personal information updated');
        Swal.fire({
            icon: 'success',
            title: 'Saved',
            text: 'Your personal information has been updated successfully.',
            confirmButtonColor: '#F00'
        });
        validate();
    });
}

// Security Form
function initSecurityForm() {
    const cur = qs('#curPwd');
    const np = qs('#newPwd');
    const cp = qs('#confPwd');
    const btn = qs('#btnUpdatePassword');
    const bar = qs('#pwdStrengthBar');
    const txt = qs('#pwdStrengthText');
    const badge = qs('#pwdRulesBadge');

    qsa('.toggle-visibility-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const targetId = icon.getAttribute('data-target');
            const input = qs('#' + targetId);
            input.type = input.type === 'password' ? 'text' : 'password';
            const i = icon.querySelector('i');
            i.classList.toggle('fa-eye');
            i.classList.toggle('fa-eye-slash');
        });
    });

    function scorePassword(p) {
        let score = 0;
        if (!p) return 0;
        if (p.length >= 8) score += 1;
        if (p.length >= 12) score += 1;
        if (/[a-z]/.test(p)) score += 1;
        if (/[A-Z]/.test(p)) score += 1;
        if (/[0-9]/.test(p)) score += 1;
        if (/[^A-Za-z0-9]/.test(p)) score += 1;
        return Math.min(score, 5); // 0..5
    }

    function renderStrength() {
        const s = scorePassword(np.value);
        const pct = (s / 5) * 100;
        bar.style.width = pct + '%';
        let color = '#dc3545',
            label = 'Too weak';
        if (s >= 4) {
            color = '#28a745';
            label = 'Strong';
        } else if (s === 3) {
            color = '#ffc107';
            label = 'Medium';
        } else if (s === 2) {
            color = '#fd7e14';
            label = 'Weak';
        }
        bar.style.backgroundColor = color;
        txt.textContent = label;
        badge.textContent = s >= 4 ? 'Good to go' : 'Follow the rules';
        badge.className = 'badge-soft ' + (s >= 4 ? 'success' : 'warning');
    }

    function validate() {
        // Required
        cur.classList.toggle('is-invalid', cur.value.trim() === '');
        np.classList.toggle('is-invalid', np.value.trim().length < 8);
        const match = np.value && (np.value === cp.value);
        cp.classList.toggle('is-invalid', !match);
        // Not same as current
        const different = np.value && cur.value && (np.value !== cur.value);
        // Complexity
        const s = scorePassword(np.value);
        const valid = cur.value && np.value && cp.value && match && different && s >= 3;
        btn.disabled = !valid;
    }

    [cur, np, cp].forEach(el => el.addEventListener('input', () => {
        renderStrength();
        validate();
    }));
    renderStrength();

    btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating';
        await new Promise(r => setTimeout(r, 1200)); // simulate API
        btn.innerHTML = '<i class="fa-solid fa-key me-1"></i> Update Password';
        cur.value = '';
        np.value = '';
        cp.value = '';
        renderStrength();
        validate();
        Swal.fire({
            icon: 'success',
            title: 'Password Updated',
            text: 'Your password was changed successfully.',
            confirmButtonColor: '#F00'
        });
    });
}

// Contacts
function initContacts() {
    state.contacts = initialContacts.slice();
    renderContacts();
    qs('#contactsSearch').addEventListener('input', (e) => {
        state.filter = e.target.value.toLowerCase();
        state.contactPage = 1;
        renderContacts();
    });

    qsa('#contactsTable thead th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            if (state.sort.key === key) {
                state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                state.sort.key = key;
                state.sort.dir = 'asc';
            }
            renderContacts();
        });
    });

    // Add contact
    const addForm = qs('#addContactForm');
    const nameInput = qs('#newContactName');
    const phoneInput = qs('#newContactPhone');
    const addBtn = qs('#btnAddContact');

    function validateAdd() {
        const nv = nameInput.value.trim().length > 0;
        const pv = e164.test(phoneInput.value.trim());
        nameInput.classList.toggle('is-invalid', !nv && nameInput.value.trim().length > 0);
        phoneInput.classList.toggle('is-invalid', !pv && phoneInput.value.trim().length > 0);
        addBtn.disabled = !(nv && pv);
    }

    nameInput.addEventListener('input', validateAdd);
    phoneInput.addEventListener('input', validateAdd);

    addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        validateAdd();
        if (addBtn.disabled) return;
        const newC = {
            id: 'c' + (Math.random().toString(36).slice(2, 8)),
            name: nameInput.value.trim(),
            phone: phoneInput.value.trim(),
            added: new Date().toISOString()
        };
        state.contacts.unshift(newC);
        nameInput.value = '';
        phoneInput.value = '';
        addBtn.disabled = true;
        state.contactPage = 1;
        renderContacts();
        showToast('Contact added');
    });
}

function renderContacts() {
    const tbody = qs('#contactsTbody');
    tbody.innerHTML = '';
    // Filter
    let items = state.contacts.filter(c =>
        c.name.toLowerCase().includes(state.filter) || c.phone.toLowerCase().includes(state.filter)
    );
    // Sort
    items.sort((a, b) => {
        const key = state.sort.key;
        let va = a[key],
            vb = b[key];
        if (key === 'added') {
            va = new Date(va).getTime();
            vb = new Date(vb).getTime();
        }
        if (typeof va === 'string') {
            va = va.toLowerCase();
            vb = vb.toLowerCase();
        }
        if (va < vb) return state.sort.dir === 'asc' ? -1 : 1;
        if (va > vb) return state.sort.dir === 'asc' ? 1 : -1;
        return 0;
    });
    // Pagination
    const total = items.length;
    const pages = Math.max(1, Math.ceil(total / state.pageSize));
    state.contactPage = Math.min(state.contactPage, pages);
    const start = (state.contactPage - 1) * state.pageSize;
    const pageItems = items.slice(start, start + state.pageSize);

    pageItems.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name}</td>
          <td><code>${c.phone}</code></td>
          <td>${dayjs(c.added).format('MMM D, YYYY')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" title="Message" data-bs-toggle="tooltip"><i class="fa-solid fa-message"></i></button>
            <button class="btn btn-sm btn-danger" data-id="${c.id}"><i class="fa-solid fa-trash-can me-1"></i>Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
    });

    // Actions
    qsa('#contactsTbody .btn-danger').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const item = state.contacts.find(x => x.id === id);
            Swal.fire({
                title: 'Remove contact?',
                text: `Remove ${item.name} ( ${item.phone} ) from your emergency contacts?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#F00',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove'
            }).then((result) => {
                if (result.isConfirmed) {
                    state.contacts = state.contacts.filter(x => x.id !== id);
                    renderContacts();
                    showToast('Contact removed');
                }
            });
        });
    });

    // Summary
    const end = Math.min(start + state.pageSize, total);
    qs('#contactsSummary').textContent = total === 0 ? 'No contacts found' : `Showing ${start + 1}-${end} of ${total}`;

    // Pagination UI
    const pag = qs('#contactsPagination');
    pag.innerHTML = '';
    const prev = document.createElement('li');
    prev.className = 'page-item' + (state.contactPage === 1 ? ' disabled' : '');
    prev.innerHTML = `<a class="page-link" href="#" aria-label="Previous">&laquo;</a>`;
    prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (state.contactPage > 1) {
            state.contactPage--;
            renderContacts();
        }
    });
    pag.appendChild(prev);

    for (let p = 1; p <= pages; p++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (p === state.contactPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${p}</a>`;
        li.addEventListener('click', (e) => {
            e.preventDefault();
            state.contactPage = p;
            renderContacts();
        });
        pag.appendChild(li);
    }

    const next = document.createElement('li');
    next.className = 'page-item' + (state.contactPage === pages ? ' disabled' : '');
    next.innerHTML = `<a class="page-link" href="#" aria-label="Next">&raquo;</a>`;
    next.addEventListener('click', (e) => {
        e.preventDefault();
        if (state.contactPage < pages) {
            state.contactPage++;
            renderContacts();
        }
    });
    pag.appendChild(next);

    initTooltips();
}

// View switcher (demonstrative)
function initViewSwitcher() {
    qsa('.view-switcher .option').forEach(opt => {
        opt.addEventListener('click', () => {
            qsa('.view-switcher .option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            document.body.classList.remove('view-grid', 'view-table', 'view-tiles');
            document.body.classList.add(opt.dataset.view);
        });
    });
}

// Chart.js login activity
function initChart() {
    const ctx = qs('#loginActivityChart');
    if (!ctx) return;
    const labels = Array.from({
        length: 7
    }).map((_, i) => dayjs().subtract(6 - i, 'day').format('ddd'));
    const data = [1, 0, 2, 1, 3, 1, 2];
    new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Successful logins',
                data,
                borderColor: '#0099D2',
                backgroundColor: 'rgba(0,153,210,0.1)',
                tension: 0.3,
                pointRadius: 3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}
  </script>
 </body>
</html>
