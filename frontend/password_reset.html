<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   DisasterEye | Password Reset
  </title>
  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfN3FB8H6rI8d+tATqQpF1YF2V5cJQF4r8G2YeliKZm4vDWw8clWkP3g==" referrerpolicy="no-referrer" rel="stylesheet">
   <!-- SweetAlert2 -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Site Theme CSS -->
    <link href="style.css" rel="stylesheet"/>
    <!-- Page-specific CSS -->
    <link href="password_reset.css" rel="stylesheet"/>
   </link>
  </link>
 </head>
 <body class="d-flex flex-column min-vh-100">
  <!-- Public/Common Auth Header -->
  <header class="navbar navbar-expand bg-white border-bottom shadow-sm" style="--primary:#FF0000; --secondary:#FFD700;">
   <div class="container-fluid">
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle sidebar" class="btn d-md-none" data-bs-target="#sidebarMenu" data-bs-toggle="collapse" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center gap-2" href="./login_page.html">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/disastereye/56/56'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:28px;"/>
     <span class="fw-bold" style="color:var(--primary)">
      DisasterEye
     </span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-2">
     <a class="btn btn-outline-danger btn-sm" href="./login_page.html">
      <i class="fa-solid fa-right-to-bracket me-1">
      </i>
      Log In
     </a>
     <a class="btn btn-danger btn-sm" href="./registration_page.html" style="background-color:#FF0000; border-color:#FF0000;">
      <i class="fa-solid fa-user-plus me-1">
      </i>
      Sign Up
     </a>
    </div>
   </div>
  </header>
  <main class="flex-fill">
   <div class="container-fluid">
    <div class="row g-0">
     <!-- Public/Common Auth Sidebar (Applicable for password_reset) -->
     <aside class="col-md-auto border-end">
      <nav class="collapse d-md-block bg-light border-end" id="sidebarMenu" style="min-height:100vh; width:260px;">
       <div class="position-sticky">
        <div class="p-3 border-bottom d-flex align-items-center gap-2">
         <img alt="DisasterEye Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/de-logo/64/64'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:32px;"/>
         <span class="fw-bold">
          DisasterEye
         </span>
        </div>
        <div class="p-3">
         <div class="mb-3 small text-muted">
          Welcome. Please sign in or create an account.
         </div>
         <ul class="nav nav-pills flex-column gap-1">
          <li class="nav-item">
           <a class="nav-link d-flex align-items-center" href="./login_page.html">
            <i class="fa-solid fa-right-to-bracket me-2 text-danger">
            </i>
            Log In
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link d-flex align-items-center" href="./registration_page.html">
            <i class="fa-solid fa-user-plus me-2 text-danger">
            </i>
            Register
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link d-flex align-items-center active" href="./password_reset.html">
            <i class="fa-solid fa-key me-2 text-danger">
            </i>
            Password Reset
           </a>
          </li>
          <li class="nav-item">
           <a class="nav-link d-flex align-items-center" href="./verification_page.html">
            <i class="fa-solid fa-envelope-circle-check me-2 text-danger">
            </i>
            Verify Account
           </a>
          </li>
         </ul>
         <hr/>
         <div class="small text-muted d-flex align-items-center">
          <i class="fa-solid fa-circle-question me-2 text-warning">
          </i>
          Need help? See FAQs after sign-in
         </div>
        </div>
       </div>
      </nav>
     </aside>
     <!-- Main Content -->
     <section class="col p-3 p-md-4 d-flex justify-content-center align-items-start">
      <div class="login-form-container w-100" style="max-width:560px;">
       <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="page-title m-0">
         Password Reset
        </h1>
        <span class="badge-soft info">
         <i class="fa-solid fa-shield-keyhole">
         </i>
         Secure
        </span>
       </div>
       <!-- System feedback area -->
       <div class="alert d-none" id="systemFeedback" role="alert">
       </div>
       <!-- Token validation state (shown only while validating token) -->
       <div class="d-none mb-3" id="tokenValidation">
        <div class="d-flex align-items-center gap-2">
         <div class="spinner-border text-primary" role="status" style="width:1.25rem;height:1.25rem;">
          <span class="visually-hidden">
           Loading...
          </span>
         </div>
         <span class="text-muted">
          Validating your reset link…
         </span>
        </div>
       </div>
       <!-- Request Reset View -->
       <div class="card app-card mb-0" id="requestView">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-paper-plane text-info">
          </i>
          <div class="fw-semibold">
           Step 1 of 2: Request Reset Link
          </div>
         </div>
        </div>
        <div class="card-body">
         <form id="requestForm" novalidate="">
          <div class="mb-3">
           <label class="form-label" for="emailInput">
            Email address
           </label>
           <input class="form-control" id="emailInput" placeholder="Enter your email address" required="" type="email"/>
           <div class="form-text">
            We'll email you a link to reset your password.
           </div>
           <div class="invalid-feedback">
            Please enter a valid email address.
           </div>
          </div>
          <div class="d-grid gap-2">
           <button class="btn btn-info" id="btnSendLink" type="submit">
            <span class="btn-text">
             <i class="fa-solid fa-paper-plane me-1">
             </i>
             Send Reset Link
            </span>
            <span class="btn-spinner d-none">
             <span aria-hidden="true" class="spinner-border spinner-border-sm me-2" role="status">
             </span>
             Sending…
            </span>
           </button>
           <a class="btn btn-light" href="./login_page.html">
            <i class="fa-solid fa-arrow-left me-1">
            </i>
            Back to Login
           </a>
          </div>
         </form>
        </div>
       </div>
       <!-- Set New Password View -->
       <div class="card app-card d-none mb-0" id="resetView">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-lock text-success">
          </i>
          <div class="fw-semibold">
           Step 2 of 2: Set New Password
          </div>
         </div>
        </div>
        <div class="card-body">
         <form id="resetForm" novalidate="">
          <div class="mb-3">
           <label class="form-label" for="newPassword">
            New Password
           </label>
           <div class="input-group">
            <input aria-describedby="pwdHelp" class="form-control" id="newPassword" placeholder="Enter new password" required="" type="password"/>
            <button aria-label="Toggle password visibility" class="btn btn-light toggle-visibility-icon" data-target="#newPassword" type="button">
             <i class="fa-regular fa-eye">
             </i>
            </button>
           </div>
           <div class="form-text" id="pwdHelp">
            Use at least 8 characters, including uppercase, number, and special character.
           </div>
          </div>
          <div class="mb-2">
           <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">
             Password strength
            </small>
            <small class="fw-semibold text-muted" id="strengthLabel">
             —
            </small>
           </div>
           <div class="progress" style="height:8px;">
            <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%">
            </div>
           </div>
          </div>
          <div class="mb-3 mt-3">
           <label class="form-label" for="confirmPassword">
            Confirm New Password
           </label>
           <div class="input-group">
            <input class="form-control" id="confirmPassword" placeholder="Confirm new password" required="" type="password"/>
            <button aria-label="Toggle password visibility" class="btn btn-light toggle-visibility-icon" data-target="#confirmPassword" type="button">
             <i class="fa-regular fa-eye">
             </i>
            </button>
           </div>
           <div class="invalid-feedback">
            Passwords do not match.
           </div>
          </div>
          <div class="d-grid gap-2">
           <button class="btn btn-success" disabled="" id="btnResetPwd" type="submit">
            <span class="btn-text">
             <i class="fa-solid fa-rotate me-1">
             </i>
             Reset Password
            </span>
            <span class="btn-spinner d-none">
             <span aria-hidden="true" class="spinner-border spinner-border-sm me-2" role="status">
             </span>
             Processing…
            </span>
           </button>
           <a class="btn btn-light" href="./login_page.html">
            <i class="fa-solid fa-arrow-left me-1">
            </i>
            Back to Login
           </a>
          </div>
         </form>
        </div>
       </div>
      </div>
     </section>
    </div>
   </div>
  </main>
  <!-- Public/Common Auth Footer -->
  <footer class="border-top mt-auto bg-light">
   <div class="container py-3 d-flex flex-wrap align-items-center justify-content-between small">
    <div class="d-flex align-items-center gap-2">
     <img alt="Logo" onerror="this.onerror=null;this.src='https://picsum.photos/seed/de-footer/40/40'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68c2bc58b3f88442584e5f26/logos/logo_07c28723-6add-4475-a1c8-2b377d0b765d.jpg" style="height:20px;"/>
     <span class="text-muted">
      © 2025 DisasterEye
     </span>
    </div>
    <ul class="nav">
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="#">
       Terms
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="#">
       Privacy
      </a>
     </li>
     <li class="nav-item">
      <a class="nav-link px-2 text-muted" href="./profile_settings.html">
       Contact
      </a>
     </li>
    </ul>
   </div>
  </footer>
  <!-- Bootstrap JS -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js">
  </script>
  <script>
   document.addEventListener('DOMContentLoaded', () => {
    const systemFeedback = document.getElementById('systemFeedback');
    const tokenValidation = document.getElementById('tokenValidation');
    const requestView = document.getElementById('requestView');
    const resetView = document.getElementById('resetView');

    const emailInput = document.getElementById('emailInput');
    const requestForm = document.getElementById('requestForm');
    const btnSendLink = document.getElementById('btnSendLink');

    const resetForm = document.getElementById('resetForm');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const strengthBar = document.getElementById('strengthBar');
    const strengthLabel = document.getElementById('strengthLabel');
    const btnResetPwd = document.getElementById('btnResetPwd');

    // Helper: show/hide views
    function showRequestView() {
        requestView.classList.remove('d-none');
        resetView.classList.add('d-none');
    }

    function showResetView() {
        requestView.classList.add('d-none');
        resetView.classList.remove('d-none');
    }

    function setFeedback(type, message) {
        systemFeedback.className = 'alert alert-' + type;
        systemFeedback.textContent = message;
        if (!message) {
            systemFeedback.classList.add('d-none');
        } else {
            systemFeedback.classList.remove('d-none');
        }
    }

    // Email validation
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    // Password strength
    function passwordStrength(pwd) {
        let score = 0;
        const rules = [
            /.{8,}/, // length
            /[A-Z]/, // uppercase
            /[a-z]/, // lowercase
            /[0-9]/, // number
            /[^A-Za-z0-9]/ // special
        ];
        rules.forEach(r => score += r.test(pwd) ? 1 : 0);
        return score; // 0..5
    }

    function updateStrengthUI(pwd) {
        const score = passwordStrength(pwd);
        const percent = (score / 5) * 100;
        strengthBar.style.width = percent + '%';
        strengthBar.setAttribute('aria-valuenow', percent.toString());
        let label = 'Weak';
        let cls = 'bg-danger';
        if (score >= 4) {
            label = 'Strong';
            cls = 'bg-success';
        } else if (score === 3) {
            label = 'Good';
            cls = 'bg-warning';
        } else if (score === 2) {
            label = 'Fair';
            cls = 'bg-warning';
        } else {
            label = 'Weak';
            cls = 'bg-danger';
        }
        strengthLabel.textContent = label;
        strengthBar.className = 'progress-bar ' + cls;
    }

    function canSubmitReset() {
        const pwd = newPassword.value.trim();
        const conf = confirmPassword.value.trim();
        const strongEnough = passwordStrength(pwd) >= 4;
        const match = pwd && conf && pwd === conf;
        return strongEnough && match;
    }

    function setLoading(button, isLoading) {
        const text = button.querySelector('.btn-text');
        const spinner = button.querySelector('.btn-spinner');
        if (isLoading) {
            button.disabled = true;
            if (text) text.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
        } else {
            button.disabled = false;
            if (text) text.classList.remove('d-none');
            if (spinner) spinner.classList.add('d-none');
        }
    }

    // Toggle visibility buttons
    document.querySelectorAll('.toggle-visibility-icon').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetSel = btn.getAttribute('data-target');
            const input = document.querySelector(targetSel);
            if (!input) return;
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });

    // Validate token from URL
    const params = new URLSearchParams(window.location.search);
    const resetToken = params.get('token');

    function mockValidateToken(token) {
        return new Promise((resolve) => {
            setTimeout(() => {
                // Demo logic: token 'expired' is invalid; anything else non-empty is valid
                if (!token || token.trim() === '' || token === 'expired') {
                    resolve({
                        valid: false,
                        reason: 'invalid_or_expired'
                    });
                } else {
                    resolve({
                        valid: true
                    });
                }
            }, 800);
        });
    }

    async function initView() {
        if (resetToken) {
            tokenValidation.classList.remove('d-none');
            requestView.classList.add('d-none');
            resetView.classList.add('d-none');
            setFeedback('', '');
            const result = await mockValidateToken(resetToken);
            tokenValidation.classList.add('d-none');
            if (result.valid) {
                showResetView();
                setFeedback('success', 'Your reset link is valid. Please set a new password.');
            } else {
                showRequestView();
                setFeedback('warning', 'Your reset link is invalid or expired. Please request a new link.');
            }
        } else {
            showRequestView();
            setFeedback('', '');
        }
    }

    // Request form handlers
    emailInput.addEventListener('input', () => {
        if (emailInput.value && !isValidEmail(emailInput.value)) {
            emailInput.classList.add('is-invalid');
        } else {
            emailInput.classList.remove('is-invalid');
        }
        btnSendLink.disabled = !isValidEmail(emailInput.value);
    });

    requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isValidEmail(emailInput.value)) {
            emailInput.classList.add('is-invalid');
            return;
        }
        setLoading(btnSendLink, true);
        try {
            await new Promise((res) => setTimeout(res, 1000)); // mock API
            setFeedback('info', 'If an account exists for that email, a reset link has been sent. Please check your inbox.');
            Swal.fire({
                icon: 'success',
                title: 'Check your email',
                text: 'We sent a link to reset your password if the email exists in our system.',
                confirmButtonColor: '#FF0000'
            });
        } catch (err) {
            setFeedback('danger', 'Something went wrong. Please try again later.');
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please try again later.',
                confirmButtonColor: '#FF0000'
            });
        } finally {
            setLoading(btnSendLink, false);
        }
    });

    // Reset form handlers
    newPassword.addEventListener('input', () => {
        updateStrengthUI(newPassword.value);
        // If confirm filled, re-validate match
        if (confirmPassword.value) {
            if (confirmPassword.value !== newPassword.value) {
                confirmPassword.classList.add('is-invalid');
            } else {
                confirmPassword.classList.remove('is-invalid');
            }
        }
        btnResetPwd.disabled = !canSubmitReset();
    });

    confirmPassword.addEventListener('input', () => {
        if (confirmPassword.value && confirmPassword.value !== newPassword.value) {
            confirmPassword.classList.add('is-invalid');
        } else {
            confirmPassword.classList.remove('is-invalid');
        }
        btnResetPwd.disabled = !canSubmitReset();
    });

    resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!canSubmitReset()) return;
        setLoading(btnResetPwd, true);
        try {
            await new Promise((res) => setTimeout(res, 1200)); // mock API call
            setFeedback('success', 'Your password has been reset successfully. Redirecting to login…');
            Swal.fire({
                icon: 'success',
                title: 'Password reset successful',
                text: 'You will be redirected to the login page.',
                timer: 2500,
                showConfirmButton: false
            });
            setTimeout(() => {
                window.location.href = './login_page.html';
            }, 2400);
        } catch (err) {
            setFeedback('danger', 'Could not reset password. Please try again.');
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Could not reset password.',
                confirmButtonColor: '#FF0000'
            });
        } finally {
            setLoading(btnResetPwd, false);
        }
    });

    // Initialize view
    initView();
});
  </script>
 </body>
</html>
